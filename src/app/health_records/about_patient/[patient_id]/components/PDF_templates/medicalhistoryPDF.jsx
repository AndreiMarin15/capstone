"use client";
import {
	Table,
	TableBody,
	TableCaption,
	TableCell,
	TableFooter,
	TableHead,
	TableHeader,
	TableRow,
} from "@/components/ui/table";
import html2canvas from "html2canvas";
import jsPDF from "jspdf";
import { useRef } from "react";
import { Button } from "@/components/ui/button";
import { getMedicalHistory, getDoctorSpecialization, getDoctorHospital } from "@/backend/pdfBackend/getPDFData";
import { useEffect, useState } from "react";
import { currentUser } from "@/app/store";
import { useRecordValidity } from "@/app/store";
export function MedicalHistoryPDF({ patientId, patientData }) {
	const [medicalhistory, setMedicalHistory] = useState([
		{
			number: "1", // wala sa fhir pang count lang ng rows (number)
			diagnosis: "Type 2 Diabetes", // observation table: id-diagnosis (string)
			date: "2020-01-24", // observation table: date (date)
			provider: "Dr. Harold Chiu", // observation table: actor (string)
			specialization: "Endocrinologist", // user table: specialization (string)
			hospital: "Philippine General Hospital", // hindi pa sinesave sa tables sa supabase
		},
		{
			number: "2",
			diagnosis: "Ketoacidosis",
			date: "2023-08-09",
			provider: "Dr. Eli Cruz",
			specialization: "Endocrinologist",
			hospital: "Taytay Hospital",
		},
	]);

	useEffect(() => {
		const fetchData = async () => {
			console.log(patientData);
			const response = await getMedicalHistory(patientId);
			console.log(response);

			const medicalHistoryPromises = response
				.filter((medicalhistory) => medicalhistory.resource.valueString)
				.map(async (medicalhistory, index) => {
					const specialization = await getDoctorSpecialization(medicalhistory.resource.participant.license_id);
					const hospital = await getDoctorHospital(medicalhistory.resource.participant.license_id);
					console.log(medicalhistory)
					console.log(medicalhistory.resource.participant.license_id)
					// Await for both promises to resolve

					console.log(specialization, hospital);
					return {
						number: index + 1,
						diagnosis: medicalhistory.resource.valueString || "",
						date: medicalhistory.ts,
						provider: medicalhistory.resource.participant.actor,
						specialization,
						hospital,
					};
				});

			// Wait for all promises to resolve and then set the medical history
			const medicalHistoryResolved = await Promise.all(medicalHistoryPromises);
			setMedicalHistory(medicalHistoryResolved);
		};

		fetchData();
	}, [patientId, useRecordValidity.getState()]);

	const pdfRef = useRef();
	const downloadPDF = () => {
		const input = pdfRef.current;

		// Remove the 'hidden' class
		input.classList.remove("hidden");

		const width = input.offsetWidth;
		const height = input.offsetHeight;
		let computedWidth = width;
		let computedHeight = height;
		console.log(width, height);
		if (width < 1920 / 2) {
			computedWidth = 1920 / 2;
			// computedHeight = computedWidth / 2;
		}
		if (height < 1080 / 2) {
			computedHeight = 1080 / 2;
			// computedWidth = computedHeight * 2;
		}

		console.log(computedWidth, computedHeight);

		html2canvas(input)
			.then((canvas) => {
				const imgData = canvas.toDataURL("image/png");
				const pdf = new jsPDF("l", "px", [computedWidth, computedHeight]);
				pdf.addImage(imgData, "PNG", 0, 0, width, height);
				pdf.save(`Medical History.pdf`);
			})
			.finally(() => {
				// Add the 'hidden' class back after the PDF has been downloaded
				input.classList.add("hidden");
			});
	};
	function getCurrentDateFormatted() {
		const date = new Date();
		const monthNames = [
			"January",
			"February",
			"March",
			"April",
			"May",
			"June",
			"July",
			"August",
			"September",
			"October",
			"November",
			"December",
		];
		const month = monthNames[date.getMonth()];
		const day = date.getDate();
		const year = date.getFullYear();
		return `${month} ${day}, ${year}`;
	}
	return (
		<div className="flex items-center justify-center text-center m-2">
			<Button onClick={downloadPDF}>Download</Button>
			<div ref={pdfRef} className="hidden z-[-10] absolute" style={{ left: "-5000px" }}>
				{" "}
				<div className="text-black text-center text-base font-bold leading-5 mt-8 max-md:ml-1 max-md:mt-10">
					{patientData?.personal_information?.first_name} {patientData?.personal_information?.last_name}
				</div>
				<div className="text-black text-center text-base  leading-5max-md:ml-1 max-md:mt-10 mb-10">Medical History</div>
				<Table className="mb-5 pb-5">
					<TableCaption>
						<div className="flex items-center text-center">
							Generated by {currentUser.getState().user.first_name} {currentUser.getState().user.last_name} through
							EndoTracker on {getCurrentDateFormatted()}
						</div>
					</TableCaption>
					<TableHeader>
						<TableRow>
							<TableHead>No.</TableHead>
							{/* <TableHead>No.</TableHead> */}
							<TableHead>Diagnosis</TableHead>
							<TableHead>Date</TableHead>
							<TableHead>Provider</TableHead>
							<TableHead>Specialization</TableHead>
							<TableHead>Hospital</TableHead>
						</TableRow>
					</TableHeader>
					<TableBody className="bg-white">
						{medicalhistory?.map((medicalhistory) => (
							<TableRow key={medicalhistory?.number}>
								<TableCell className="font-medium">{medicalhistory?.number ?? 1}</TableCell>
								<TableCell className="font-medium text-left">{medicalhistory?.diagnosis}</TableCell>
								<TableCell>{medicalhistory?.date}</TableCell>
								<TableCell>{medicalhistory?.provider}</TableCell>
								<TableCell>{medicalhistory?.specialization}</TableCell>
								<TableCell>{medicalhistory?.hospital}</TableCell>
							</TableRow>
						))}
					</TableBody>
				</Table>
			</div>
		</div>
	);
}
